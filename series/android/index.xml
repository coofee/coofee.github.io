<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
      <title>Android on Simple... </title>
      <generator uri="https://gohugo.io">Hugo</generator>
    <link>http://coofee.github.io/series/android/</link>
    <language>en-us</language>
    <author>Coofee</author>
    
    <updated>Tue, 25 Jul 2017 19:43:30 CST</updated>
    
    <item>
      <title>android check app running foreground</title>
      <link>http://coofee.github.io/post/android-check-app-running-foreground/</link>
      <pubDate>Tue, 25 Jul 2017 19:43:30 CST</pubDate>
      <author>Coofee</author>
      <guid>http://coofee.github.io/post/android-check-app-running-foreground/</guid>
      <description>

&lt;h2 id=&#34;0x00-使用application-activitylifecyclecallbacks检测app运行在前台-后台&#34;&gt;0x00 使用Application.ActivityLifecycleCallbacks检测App运行在前台/后台&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;import android.app.Activity;
import android.app.ActivityManager;
import android.app.Application;
import android.content.Context;
import android.os.Bundle;
import android.os.Handler;
import android.util.Log;

import java.util.List;


public class ApplicationLifecycle implements Application.ActivityLifecycleCallbacks {

    private Handler mHandler = new Handler();

    private Runnable mCheck = new Runnable() {
        @Override
        public void run() {
            Log.e(&amp;quot;ApplicationLifecycle&amp;quot;, &amp;quot;check task exec; mCounter=&amp;quot; + mCounter);

            if (mCounter == 0) {
                Log.e(&amp;quot;ApplicationLifecycle&amp;quot;, &amp;quot;check task exec; get runningAppProcessInfo.&amp;quot;);

                final ActivityManager am = (ActivityManager) mAppContext.getSystemService(Context.ACTIVITY_SERVICE);
                // NOTE: getRunningAppProcess() ONLY GIVE YOU THE PROCESS OF YOUR OWN PACKAGE IN ANDROID M
                // BUT THAT&#39;S ENOUGH HERE
                List&amp;lt;ActivityManager.RunningAppProcessInfo&amp;gt; runningAppProcesses = am.getRunningAppProcesses();
                boolean foreground = false;
                for (ActivityManager.RunningAppProcessInfo ai : am.getRunningAppProcesses()) {
                    // KILL OTHER PROCESS OF MINE
                    if (ai.uid == android.os.Process.myUid()
                            &amp;amp;&amp;amp; ai.importance == ActivityManager.RunningAppProcessInfo.IMPORTANCE_FOREGROUND) {
                        Log.e(&amp;quot;ApplicationLifecycle&amp;quot;, ai.processName + &amp;quot; importance is IMPORTANCE_FOREGROUND.&amp;quot;);
                        foreground = true;
                        break;
                    }
                }

                if (foreground) {
                    Log.e(&amp;quot;ApplicationLifecycle&amp;quot;, &amp;quot;check task exec; background=false&amp;quot;);
                } else {
                 	Log.e(&amp;quot;ApplicationLifecycle&amp;quot;, &amp;quot;check task exec; background=true&amp;quot;);
                 }
            }
        }
    };


    private int mCounter = 0;
    private Context mAppContext = null;

    public ApplicationLifecycle(Context context) {
        mAppContext = context.getApplicationContext();
    }

    @Override
    public void onActivityCreated(Activity activity, Bundle savedInstanceState) {

    }

    @Override
    public void onActivityStarted(Activity activity) {

    }

    @Override
    public void onActivityResumed(Activity activity) {
        mCounter++;
        Log.e(&amp;quot;ApplicationLifecycle&amp;quot;, &amp;quot;onActivityResumed mCounter=&amp;quot; + mCounter);
        mHandler.removeCallbacks(mCheck);
    }

    @Override
    public void onActivityPaused(Activity activity) {
        mCounter--;
        Log.e(&amp;quot;ApplicationLifecycle&amp;quot;, &amp;quot;onActivityPaused post check task; mCounter=&amp;quot; + mCounter);

        mHandler.removeCallbacks(mCheck);
        mHandler.postDelayed(mCheck, 2000);
    }

    @Override
    public void onActivityStopped(Activity activity) {

    }

    @Override
    public void onActivitySaveInstanceState(Activity activity, Bundle outState) {

    }

    @Override
    public void onActivityDestroyed(Activity activity) {

    }
}

&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;0x01-杀进程的各种方法&#34;&gt;0x01 杀进程的各种方法&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;if (Build.VERSION.SDK_INT &amp;gt;= 21) {
    finishAndRemoveTask();
}

if (Build.VERSION.SDK_INT &amp;gt;= 16) {
    finishAffinity();
}

ActivityManager activityManager = (ActivityManager) getSystemService(ACTIVITY_SERVICE);
activityManager.killBackgroundProcesses(getPackageName());

android.os.Process.killProcess(android.os.Process.myPid());// kill process
System.exit(-1);
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>upgrade android sdk</title>
      <link>http://coofee.github.io/post/upgrade-android-sdk-android-support-library/</link>
      <pubDate>Thu, 13 Jul 2017 19:52:39 CST</pubDate>
      <author>Coofee</author>
      <guid>http://coofee.github.io/post/upgrade-android-sdk-android-support-library/</guid>
      <description>

&lt;h2 id=&#34;1-gradle-plugin-2-2-0-android-sdk-25都需要jdk-1-8&#34;&gt;1. gradle plugin 2.2.0+、android sdk 25都需要jdk 1.8。&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-groovy&#34;&gt;buildscript {
    repositories {
        jcenter()
    }
    dependencies {
        classpath &#39;com.android.tools.build:gradle:2.2.0&#39;
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;在执行gradle脚本时，可以在参数中指定jdk版本，如下所示：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;gradlew clean -Dorg.gradle.java.home=/usr/java/jdk1.8
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;也可以直接在&lt;code&gt;gradle.properties&lt;/code&gt;中指定jdk版本，如下所示：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-groovy&#34;&gt;org.gradle.java.home=/usr/java/jdk1.8
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;2-build-tools-24-0-2以上的的aapt需要将centos-6-5的glibc升级到glibc-2-14&#34;&gt;2. build-tools/24.0.2以上的的aapt需要将centOS 6.5的GLIBC升级到GLIBC_2.14。&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[exec] /android-sdk-linux/build-tools/24.0.2/aapt: /lib64/libc.so.6: version `GLIBC_2.14&#39; not found (required by /android-sdk-linux/build-tools/24.0.2/aapt)
[exec] /android-sdk-linux/build-tools/24.0.2/aapt: /lib64/libc.so.6: version `GLIBC_2.14&#39; not found (required by /android-sdk-linux/build-tools/24.0.2/lib64/libc++.so)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;可以使用&lt;code&gt;strings /lib64/libc.so.6 | grep GLIBC&lt;/code&gt;获取GLIBC的版本。&lt;/p&gt;

&lt;p&gt;&lt;em&gt;注意：build-tools使用23.0.2时则不需要升级。&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;注意：build-tools使用23.0.2时则不需要升级。&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;build-tools版本保持22.0.1不变时，在HUAWEI P7-L00 4.4.2上面运行时，会出现如下错误，出错原因是因为support库版本和build-tools主版本号不一致导致，所以如果升级support库版本，最好保持和build-tools版本一致。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;Caused by: android.content.res.Resources$NotFoundException: File res/drawable/abc_vector_test.xml from drawable resource ID #0x7f820053
  at android.content.res.Resources.loadDrawable(Resources.java:2154)
  at com.huawei.android.content.res.ResourcesEx.loadDrawable(ResourcesEx.java:723)
  at android.content.res.Resources.getDrawable(Resources.java:741)
  at android.support.v4.content.ContextCompat.getDrawable(ContextCompat.java:374)
  at android.support.v7.widget.AppCompatDrawableManager.getDrawable(AppCompatDrawableManager.java:202)
  at android.support.v7.widget.AppCompatDrawableManager.getDrawable(AppCompatDrawableManager.java:190)
  at android.support.v7.widget.AppCompatDrawableManager.checkVectorDrawableSetup(AppCompatDrawableManager.java:711)
  at android.support.v7.widget.AppCompatDrawableManager.getDrawable(AppCompatDrawableManager.java:195)
  at android.support.v7.widget.AppCompatDrawableManager.getDrawable(AppCompatDrawableManager.java:190)
  at android.support.v7.content.res.AppCompatResources
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;3-targetsdkversion-support-library-upgrade&#34;&gt;3. targetSdkVersion &amp;amp; support library upgrade&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;targetSdkVersion=25时libssl.so已经被系统移除了，所以如果有使用openssl的需要做兼容。注: android 6.0已经使用&lt;code&gt;BoringSSL&lt;/code&gt;替换了&lt;code&gt;OpenSSL&lt;/code&gt;。&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;support库升级到25.4.0时，需要使用google官方的maven仓库(&lt;a href=&#34;https://maven.google.com&#34;&gt;https://maven.google.com&lt;/a&gt;) 需要翻墙，解决方案如下:&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-groovy&#34;&gt;allprojects {
    repositories {
        maven {
            url &amp;quot;https://dl.google.com/dl/android/maven2/&amp;quot;
        }
        jcenter()
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;support库升级到25.4.0时，使用&lt;code&gt;CoordinatorLayout&lt;/code&gt;控件的页面，Activity的主题必须继承&lt;code&gt;Theme.AppCompat&lt;/code&gt;，否则会直接崩溃，错误日志如下：&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;Caused by: java.lang.IllegalArgumentException: You need to use a Theme.AppCompat theme (or descendant) with the design library.
	at android.support.design.widget.ThemeUtils.checkAppCompatTheme(ThemeUtils.java:33)
	at android.support.design.widget.CoordinatorLayout.&amp;lt;init&amp;gt;(CoordinatorLayout.java:206)
	at android.support.design.widget.CoordinatorLayout.&amp;lt;init&amp;gt;(CoordinatorLayout.java:200)
	at java.lang.reflect.Constructor.newInstance0(Native Method) 
	at java.lang.reflect.Constructor.newInstance(Constructor.java:430) 
	at android.view.LayoutInflater.createView(LayoutInflater.java:656) 
	at android.view.LayoutInflater.createViewFromTag(LayoutInflater.java:798) 
	at android.view.LayoutInflater.createViewFromTag(LayoutInflater.java:738) 
	at android.view.LayoutInflater.inflate(LayoutInflater.java:495) 
	at android.view.LayoutInflater.inflate(LayoutInflater.java:426) 
	at android.view.LayoutInflater.inflate(LayoutInflater.java:377) 
	at com.wuba.home.fragment.HomeFragment.initView(HomeFragment.java:273) 
	at com.wuba.home.fragment.HomeFragment.onCreateView(HomeFragment.java:260) 
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;RecyclerView在&lt;strong&gt;23.2&lt;/strong&gt;版本支持&lt;code&gt;setAutoMeasureEnabled()&lt;/code&gt;，当item布局是&lt;code&gt;match_parent&lt;/code&gt;时，这个item会占满整个RecyclerView的高度/宽度，所以当从低版本升级到高版本时需要将&lt;code&gt;match_parent&lt;/code&gt;替换为精确的宽度/高度，或者使用&lt;code&gt;wrap_content&lt;/code&gt;。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;原因如下:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;The RecyclerView widget provides an advanced and flexible base for creating lists and grids as well as supporting animations. This release brings an exciting new feature to the LayoutManager API: auto-measurement! This allows a RecyclerView to size itself based on the size of its contents. This means that previously unavailable scenarios, such as using WRAP_CONTENT for a dimension of the RecyclerView, are now possible. You’ll find all built in LayoutManagers now support auto-measurement.&lt;/p&gt;

&lt;p&gt;Due to this change, make sure to double check the layout parameters of your item views: previously ignored layout parameters (such as MATCH_PARENT in the scroll direction) will now be fully respected.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&#34;https://android-developers.googleblog.com/2016/02/android-support-library-232.html&#34;&gt;详见: RecyclerView 23.2.0&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;如果布局xml非常多，修改麻烦的话，可以考虑在&lt;code&gt;Adapter.onCreateViewHolder()&lt;/code&gt;方法中直接修改itemView的属性即可，下面是一个竖直RecyclerView的样例：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;ViewGroup.LayoutParams layoutParams = itemView.getLayoutParams();
if (layoutParams == null) {
    layoutParams = new ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT);
    itemView.setLayoutParams(layoutParams);

} else if (layoutParams.height == ViewGroup.LayoutParams.MATCH_PARENT) {
    layoutParams.height = ViewGroup.LayoutParams.WRAP_CONTENT;
    itemView.setLayoutParams(layoutParams);

}

&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;RecyclerView隐藏ItemView&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;在RecyclerView中即使itemView整个设置了GONE，仍然会占据空间，所以如果需要隐藏整个itemView的话，需要设置其宽度、高度为0.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;public static void hideItemView(View itemView) {
    if (itemView == null) {
        return;
    }

    itemView.setVisibility(View.GONE);
    ViewGroup.LayoutParams layoutParams = itemView.getLayoutParams();
    if (layoutParams == null) {
        layoutParams = new ViewGroup.LayoutParams(0, 0);
    }

    layoutParams.height = 0;
    layoutParams.width = 0;
    itemView.setLayoutParams(layoutParams);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;4-可以考虑升级multidex以及其他修改&#34;&gt;4. 可以考虑升级multidex以及其他修改&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;可以考虑使用Fragment时使用&lt;code&gt;commitNow()&lt;/code&gt;方法替换&lt;code&gt;executePendingTransactions()&lt;/code&gt;。&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;multidex 升级到 &lt;code&gt;1.0.2&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;Allows multidexing of instrumentation APK.
Deprecates MultiDexTestRunner (AndroidJUnitRunner should be used instead).&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;Provides better protection against some bad archive extraction management of the app.&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;Fixes a bug that could lead to abandoned temporary files.&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;Provides faster installation when done in concurrent process.&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;Fixes an installation bug on API 19 and 20.&lt;br /&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;

&lt;p&gt;升级1.0.2之后直接编译，会出现以下问题:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Error:Conflict with dependency &#39;com.android.support:multidex&#39;. Resolved versions for app (1.0.2) and test app (1.0.1) differ. See http://g.co/androidstudio/app-test-app-conflict for details.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;解决这个问题，则需要在test依赖中手动指定&lt;code&gt;multidex&lt;/code&gt;的依赖是1.0.2&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-groovy&#34;&gt;dependencies {
    androidTestCompile &#39;com.android.support:multidex:1.0.2&#39;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;也可以在全部依赖中强制使用1.0.2版本即可。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-groovy&#34;&gt;configurations.all {
  resolutionStrategy {
    force &#39;com.android.support:multidex:1.0.2&#39;
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a href=&#34;https://developer.android.com/topic/libraries/support-library/revisions.html#25-4-0&#34;&gt;see support-library-25.4.0&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>
