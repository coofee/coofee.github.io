<!DOCTYPE HTML>

<html lang="en-us">

<head>
	<meta charset="utf-8">
	<title>upgrade app signature algorithm - Simple...</title>
	<meta name="author" content="map[name:Coofee email:coffeerene.zhao@gmail.com]">

	
	
	<meta name="description" content="">
	

	
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width, initial-scale=1">
    
	<link href='/index.xml' rel="alternate" title="Simple..." type="application/atom+xml">
	
	<link rel="canonical" href="http://coofee.github.io/post/upgrade-app-signature-algorithm/">
	<link href="http://coofee.github.io/favicon.png" rel="shortcut icon">
	<link href="http://coofee.github.io/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="http://coofee.github.io/css/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	
	<link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

	
	<link href="http://coofee.github.io/css/prism.css" rel="stylesheet" />
	<script src="http://coofee.github.io/js/prism.js"></script>

	
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	
	
	<script src="http://coofee.github.io/js/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5('coffeerene.zhao@gmail.com') + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
	
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="/post/about">About</a></li>
    <li><a href="/post/">Archives</a></li>
</ul>

<section class="aboutme">
  <p>
    Less is more
  </p>
</section>
</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href='mailto:coffeerene.zhao@gmail.com' title="Email">Email</a>
		
		
		
		
		
		
		
		
		
		
		
		
		
		
    	
    	
			<a class="rss" href='/index.xml' title="RSS">RSS</a>
		
	</div>
</nav>
</header>
			</div>
		</div>
		<div class="mid-col">
			
			<div class="mid-col-container">
				<div id="content" class="inner">
					<div itemscope itemtype="http://schema.org/Blog">
					<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <h1 class="title" itemprop="name">upgrade app signature algorithm</h1>
	<div class="entry-content" itemprop="articleBody">

<h1 id="android-jarsigner-apksigner">Android JarSigner &amp; ApkSigner</h1>

<p>参看<a href="https://jaq.alibaba.com/blog.htm?id=65">Shadows Everywhere漏洞浅析</a>我们可以知道，SHA1签名已经不安全了，签名算法最好升级到SHA2或者其他算法。</p>

<h2 id="0x01-android支持的签名算法">0x01 Android支持的签名算法</h2>

<p>android 4.3之前不支持SHA1之外的其他签名算法</p>

<pre><code>adb install -r /Users/zhaocongying/Downloads/notepad-sha256withrsa-sha256.apk
/Users/zhaocongying/Downloads/notepad-sha256withrsa-sha256.apk: 1 file pushed. 4.3 MB/s (62395 bytes in 0.014s)
	pkg: /data/local/tmp/notepad-sha256withrsa-sha256.apk
Failure [INSTALL_PARSE_FAILED_NO_CERTIFICATES]
</code></pre>

<blockquote>
<p>There is security vs compatibility trade off a few might be interested in. Pre-4.3, Android did not support any signature algorithms except SHA1. With Android &gt;= 4.3, SHA256 support was fixed, and SHA384, SHA512, and ECDSA were added (source). There are still android 2.3.3 (android-10) devices being sold, so anyone interested in backwards compatibility will have to heed this.</p>
</blockquote>

<p><a href="https://guardianproject.info/2015/12/29/how-to-migrate-your-android-apps-signing-key/">how-to-migrate-your-android-apps-signing-key</a></p>

<p>see bug fix</p>

<p><a href="https://issuetracker.google.com/issues/36956587">APKs signed using SHA256withRSA or with individual files hashed using SHA-256 fail to install</a></p>

<h2 id="0x01-签名生成与查看">0x01 签名生成与查看</h2>

<ul>
<li>生成keystore</li>
</ul>

<pre><code class="language-shell">keytool -genkey -v -keystore test.keystore -alias testkey -keyalg RSA -keysize 2048 -sigalg SHA256withRSA -dname &quot;cn=Test,ou=Test,c=CA&quot; -validity 10000
</code></pre>

<ul>
<li>查看APK的签名算法</li>
</ul>

<pre><code class="language-shell">keytool -printcert -jarfile notepad-sha1withrsa-sha1.apk
</code></pre>

<ul>
<li>查看keystore</li>
</ul>

<pre><code>keytool -list -v -keystore test.keystore
</code></pre>

<ul>
<li>jarsigner签名</li>
</ul>

<pre><code>jarsigner -keystore mykeystore -storepass password -sigalg SHA256withRSA -digestalg SHA256 my.apk test 
</code></pre>

<h2 id="0x02-jarsigner与apksigner的区别">0x02 jarsigner与apksigner的区别</h2>

<p>jarsigner是jdk自带的工具，apksigner是android sdk自带的工具（build-tools 24.0.3+版本才拥有）。在android build-tools 24.0.3以前默认使用jarsigner对app进行签名，在24.0.3版本以及之后使用apksigner进行签名，其中apksigner签名算法根据android的最低版本的不同而不同，jarsigner则可以直接指定签名算法(见: 上面的jarsigner签名)。</p>

<table>
<thead>
<tr>
<th align="center">tool</th>
<th align="center">minSdkVersion &lt; 18</th>
<th align="center">minSdkVersion &gt;= 18</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center">apksigner</td>
<td align="center">SHA1withRSA</td>
<td align="center">SHA256withRSA</td>
</tr>

<tr>
<td align="center">apksigner</td>
<td align="center">SHA1withDSA</td>
<td align="center">SHA256withDSA</td>
</tr>

<tr>
<td align="center">apksigner</td>
<td align="center"></td>
<td align="center">SHA256withEC</td>
</tr>
</tbody>
</table>

<p>代码详见<code>com.android.apksig.internal.apk.v1.V1SchemeSigner</code>:</p>

<pre><code class="language-java">public static DigestAlgorithm getSuggestedSignatureDigestAlgorithm(PublicKey signingKey, int minSdkVersion)
  throws InvalidKeyException
{
  String keyAlgorithm = signingKey.getAlgorithm();
  if (&quot;RSA&quot;.equalsIgnoreCase(keyAlgorithm))
  {
    if (minSdkVersion &lt; 18) {
      return DigestAlgorithm.SHA1;
    }
    return DigestAlgorithm.SHA256;
  }
  if (&quot;DSA&quot;.equalsIgnoreCase(keyAlgorithm))
  {
    if (minSdkVersion &lt; 21) {
      return DigestAlgorithm.SHA1;
    }
    return DigestAlgorithm.SHA256;
  }
  if (&quot;EC&quot;.equalsIgnoreCase(keyAlgorithm))
  {
    if (minSdkVersion &lt; 18) {
      throw new InvalidKeyException(&quot;ECDSA signatures only supported for minSdkVersion 18 and higher&quot;);
    }
    return DigestAlgorithm.SHA256;
  }
  throw new InvalidKeyException(&quot;Unsupported key algorithm: &quot; + keyAlgorithm);
}  
</code></pre>

<p><a href="https://developer.android.com/studio/command-line/apksigner.html">apksigner</a></p>

<h2 id="0x03-升级签名算法为sha2">0x03 升级签名算法为SHA2</h2>

<p>综上所示，如果我们要升级签名算法为SHA2，则android app的minSdkVersion必须大于等于18。</p>

<ul>
<li>如果直接使用apksigner签名则需要同时升级buildToolsVersion的版本大于等于24.0.3</li>
<li>如果使用jarsigner签名的话则直接指定签名算法即可。</li>
</ul>

<h2 id="0x04-遗留问题">0x04 遗留问题</h2>

<p>由于keystore未发生变化，所以使用不同签名算法的app是可以互相覆盖的，故而攻击者也可以使用旧版本的apk(使用SHA1)覆盖新版本apk(使用SHA2)继续进行攻击，所以为了避免被攻击者进行攻击的最好更换keystore，但是这样就没法覆盖安装了，哭&hellip;</p>
</div></article>
					
						<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_button_google_plusone" g:plusone:size=''></a>
	
	
	</div>
	
  	<script type="text/javascript" src='http://s7.addthis.com/js/250/addthis_widget.js#pubid='></script>
  	
</div>

					
					
					<section id="comment">
					    <h1 class="title">Comments</h1>
					    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
					</section>
					
					

<script type="text/javascript">
    
    var disqus_shortname = 'coofee-github-io';

    
    

    
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
    
</script>


				    </div>
				</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2017

    Coofee

Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a>
<script src="http://coofee.github.io/js/slash.js"></script>
<script src="http://coofee.github.io/js/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script></footer>
		</div>
	</div>
	
</body>
</html>
